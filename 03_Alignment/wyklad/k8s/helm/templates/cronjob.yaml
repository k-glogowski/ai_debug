{{- if .Values.cronjob.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.cronjob.name }}
  namespace: {{ include "adresowo-scraper.namespace" . }}
  labels:
    {{- include "adresowo-scraper.labels" . | nindent 4 }}
spec:
  # Run daily at 2 AM
  schedule: {{ .Values.cronjob.schedule | quote }}
  timeZone: {{ .Values.cronjob.timeZone | quote }}
  jobTemplate:
    spec:
      backoffLimit: {{ .Values.cronjob.backoffLimit }}
      activeDeadlineSeconds: {{ .Values.cronjob.activeDeadlineSeconds }}
      template:
        metadata:
          labels:
            app: scraper
            {{- include "adresowo-scraper.selectorLabels" . | nindent 12 }}
        spec:
          restartPolicy: OnFailure
          containers:
          {{- range .Values.cities }}
          - name: {{ .name }}-scraper
            image: {{ $.Values.image.repository }}:{{ $.Values.image.tag }}
            imagePullPolicy: {{ $.Values.image.pullPolicy }}
            env:
            - name: CITY
              value: {{ .name | quote }}
            - name: PAGES
              valueFrom:
                configMapKeyRef:
                  name: {{ $.Values.configmap.name }}
                  key: {{ .name }}_pages
            - name: DELAY
              valueFrom:
                configMapKeyRef:
                  name: {{ $.Values.configmap.name }}
                  key: DELAY
            - name: OUTPUT_DIR
              valueFrom:
                configMapKeyRef:
                  name: {{ $.Values.configmap.name }}
                  key: OUTPUT_DIR
            volumeMounts:
            - name: data-volume
              mountPath: /data
            resources:
              {{- toYaml $.Values.cronjob.resources | nindent 14 }}
          {{- end }}
          volumes:
          - name: data-volume
            persistentVolumeClaim:
              claimName: {{ .Values.pvc.name }}
{{- end }}
